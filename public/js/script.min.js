/*! script 12-02-2015 */
String.prototype.linkify=function(){var a,b,c;b=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;c=/(^|[^\/])(www\.[\S]+(\b|$))/gim;a=this.replace(b,'<a href="$1" target="_blank">$1</a>');a=a.replace(c,'$1<a href="http://$2" target="_blank">$2</a>');return a};String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)};Array.prototype.contains=function(a){var b=this.length;while(b--){if(this[b]===a)return true}return false};var Templating=function(){};Templating.prototype.messageTemplating=function(a){var b='<div class="chat-line {MESSAGE_COLOR}" data-sender="{SENDER}">'+'<span class="time">{DATE}</span>'+"{USER_BADGES_ICONS}"+'<span class="user-name" style="color: {USER_COLOR}">{USER_NAME}:</span>'+'<span class="message">{MESSAGE}</span>'+"</div>";b=b.replace("{MESSAGE_COLOR}",a.messageColor);b=b.replace("{DATE}",a.messageDate);b=b.replace("{USER_COLOR}",a.userColor);b=b.replace("{USER_NAME}",a.userName);b=b.replace("{SENDER}",a.sender);b=b.replace("{MESSAGE}",a.textMessage);b=b.replace("{USER_BADGES_ICONS}",a.userBadges);return b};Templating.prototype.actionTemplating=function(a){var b='<div class="chat-line {MESSAGE_COLOR}" data-sender="{SENDER}">'+'<span class="time">{DATE}</span>'+"{USER_BADGES_ICONS}"+'<span class="user-name" style="color: {USER_COLOR}">&bull; {USER_NAME}</span>'+'<span class="message">{MESSAGE}</span>'+"</div>";b=b.replace("{MESSAGE_COLOR}",a.messageColor);b=b.replace("{DATE}",a.messageDate);b=b.replace("{USER_COLOR}",a.userColor);b=b.replace("{USER_NAME}",a.userName);b=b.replace("{SENDER}",a.sender);b=b.replace("{MESSAGE}",a.textMessage);b=b.replace("{USER_BADGES_ICONS}",a.userBadges);return b};Templating.prototype.emoticonTemplating=function(a){var b='<span class="emoticon" style="'+"background-image: url({BACKGROUND_IMAGE}); "+"height: {HEIGHT}px; "+"width: {WIDTH}px; "+'margin: {MARGIN_TOP}px 0px;">'+"</span>";b=b.replace("{BACKGROUND_IMAGE}",a.emoticonUrl);b=b.replace("{HEIGHT}",a.emoticonHeight);b=b.replace("{WIDTH}",a.emoticonWidth);b=b.replace("{MARGIN_TOP}",a.emoticonMargins);return b};Templating.prototype.subscriberTemplating=function(a){var b='<span class="badge" style="'+'background-image: url({BACKGROUND_IMAGE});">'+"</span>";b=b.replace("{BACKGROUND_IMAGE}",a);return b};Templating.prototype.badgeTemplating=function(a){var b='<span class="badge {BADGE}"></span>';b=b.replace("{BADGE}",a);return b};var EmoticonHandler=function(){this.emoticons=[];this.badges=[];this.templating=new Templating;this.initializeEmoticons()};EmoticonHandler.prototype.replaceEmoticonSet=function(a,b){var c=this.emoticons[a];if(c!==undefined){for(var d=0;d<c.length;d++){var e=c[d],f=new RegExp(e.regex,"g");if(e.html!==undefined)b=b.replace(f,e.html)}}return b};EmoticonHandler.prototype.replaceEmoticons=function(a,b){var c=b.emoteSets;for(var d=0;d<c.length;d++){a=this.replaceEmoticonSet(c[d],a)}return a};EmoticonHandler.prototype.getUserBadges=function(a){var b="";for(var c=0;c<a.userModes.length;c++){var d=a.userModes[c];if(this.badges[d]!==undefined)b+=this.badges[d]}return b};EmoticonHandler.prototype.addToEmoticonSet=function(a,b){if(this.emoticons[a]==undefined)this.emoticons[a]=[];this.emoticons[a].push(b)};EmoticonHandler.prototype.addToGeneralEmoticons=function(a){if(this.emoticons["general"]==undefined)this.emoticons["general"]=[];this.emoticons["general"].push(a)};EmoticonHandler.prototype.buildEmoticon=function(a,b){var c=this.templating.emoticonTemplating({emoticonUrl:b.url,emoticonHeight:b.height,emoticonWidth:b.width,emoticonMargins:(18-b.height)/2}),d={regex:a.regex,url:b.url,height:b.height,width:b.width,html:c};return d};EmoticonHandler.prototype.setEmoticons=function(a){for(var b=0;b<a.length;b++){var c=a[b];for(var d=0;d<c.images.length;d++){var e=this.buildEmoticon(c,c.images[d]),f=c.images[d].emoticon_set;if(f==null)this.addToGeneralEmoticons(e);else this.addToEmoticonSet(f,e)}}};EmoticonHandler.prototype.setBadges=function(a){var b=this;$.each(a,function(a,c){if(a=="subscriber"&&c!==null)b.badges[a]=b.templating.subscriberTemplating(c.image);else b.badges[a]=b.templating.badgeTemplating(a)})};EmoticonHandler.prototype.initializeEmoticons=function(){var a=this;$.ajax({url:"/emoticons.json",dataType:"json"}).done(function(b){a.setEmoticons(b.emoticons)});$.ajax({url:"https://api.twitch.tv/kraken/chat/"+channelName.substring(1)+"/badges",dataType:"jsonp"}).done(function(b){delete b["_links"];a.setBadges(b)})};var ChatHandler=function(a,b){this.messageCount=1;this.chatBox=a;this.chatInput=b;this.maxChatMessages=150};ChatHandler.prototype.isScrolledToBottom=function(){return this.chatBox[0].scrollHeight-this.chatBox.scrollTop()-15<=this.chatBox.outerHeight()};ChatHandler.prototype.scrollDown=function(){this.chatBox.scrollTop(this.chatBox[0].scrollHeight)};ChatHandler.prototype.deleteFirstMessages=function(){while(this.messageCount>this.maxChatMessages){--this.messageCount;this.chatBox.find(".chat-line").first().remove()}};ChatHandler.prototype.addChatLine=function(a){var b=this.isScrolledToBottom();++this.messageCount;this.chatBox.append(a);if(b){this.deleteFirstMessages();this.scrollDown()}};ChatHandler.prototype.removeAllChatLines=function(){this.chatBox.find("div").remove()};ChatHandler.prototype.removeChatLinesFrom=function(a){var b=this.chatBox.find('div[data-sender="'+a+'"]');b.each(function(){$(this).removeClass().addClass("chat-line").addClass("grey");$(this).find("span.message").text("<message deleted>")})};ChatHandler.prototype.clearChatInput=function(){this.chatInput.val("")};ChatHandler.prototype.trackEvent=function(a,b,c){if(typeof ga!=="undefined"){ga("send","event",a,b,c)}};var TwitchChat=function(){this.socket=io.connect(baseUrl);this.templating=new Templating;this.chatHandler=new ChatHandler($(".chat-lines"),$(".chat-input"));this.emoticonHandler=new EmoticonHandler;this.userName=""};TwitchChat.prototype.getMessageColor=function(a,b){var c="black";if(/bob/i.test(b))c="green";if(a.userName=="gmanbot")c="blue";else if(a.userName=="twitchnotify")c="red";return c};TwitchChat.prototype.getChatLine=function(a,b,c){var d=a.linkify(),e=this.emoticonHandler.replaceEmoticons(d,b),f=this.emoticonHandler.getUserBadges(b),g={userName:b.userName.capitalize(),sender:b.userName,userColor:b.userColor,messageColor:this.getMessageColor(b,e),messageDate:moment().format("HH:mm"),textMessage:e,userBadges:f};if(c=="message")return this.templating.messageTemplating(g);else return this.templating.actionTemplating(g)};TwitchChat.prototype.addMessage=function(a,b){var c=this.getChatLine(a.message,a.user,b);this.chatHandler.addChatLine(c)};TwitchChat.prototype.deleteAllMessages=function(){this.chatHandler.removeAllChatLines()};TwitchChat.prototype.deleteMessages=function(a){this.chatHandler.removeChatLinesFrom(a)};TwitchChat.prototype.sendMessage=function(a,b){if(a!=""){this.socket.emit("message_to_send",a);this.chatHandler.clearChatInput();this.chatHandler.trackEvent("Sending Messages",b,this.userName)}};TwitchChat.prototype.sendCredentials=function(a,b){this.userName=a;this.chatHandler.trackEvent("Twitch Login","Succesful Login",this.userName);this.socket.json.emit("login",{username:a,oauth:"oauth:"+b})};var twitchChat=new TwitchChat;Twitch.init({clientId:clientId},function(a,b){if(a)console.log(a);if(b.authenticated){var c=Twitch.getToken();Twitch.api({method:"user"},function(a,b){if(a)console.log(a);twitchChat.sendCredentials(b.name,c)});$(".chat-input").attr("placeholder","Chat about this Channel")}else{$(".chat-input").attr("placeholder","Sign up or log in to chat");$(".chat-input").attr("disabled","disabled");$(".twitch-connect").show();$(".twitch-connect").click(function(){twitchChat.chatHandler.trackEvent("Twitch Login","Button");Twitch.login({redirect_uri:baseUrl,popup:false,scope:["user_read","chat_login"]})})}});$(document).ready(function(){$(".chat-input").keypress(function(a){if(a.which==13){twitchChat.sendMessage($(".chat-input").val(),"Keyboard");a.preventDefault()}});$(".send-chat-message").click(function(){twitchChat.sendMessage($(".chat-input").val(),"Button")});twitchChat.socket.on("message",function(a){twitchChat.addMessage(a,"message")});twitchChat.socket.on("action",function(a){twitchChat.addMessage(a,"action")});twitchChat.socket.on("clear_chat",function(a){twitchChat.deleteMessages(a)});twitchChat.socket.on("clear_all_chat",function(){twitchChat.deleteAllMessages()})});