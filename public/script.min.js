String.prototype.linkify=function(){var t,r,e;return r=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,e=/(^|[^\/])(www\.[\S]+(\b|$))/gim,t=this.replace(r,'<a href="$1" target="_blank">$1</a>'),t=t.replace(e,'$1<a href="http://$2" target="_blank">$2</a>')},String.prototype.replaceBetween=function(t,r,e){return this.substring(0,t)+e+this.substring(r+1)};
var Templating=function(){};Templating.prototype.userTemplating=function(e){var a='<span class="time">{DATE}</span>{USER_BADGES_ICONS}<span class="user-name" data-sender="{SENDER}" style="color: {USER_COLOR}">{USER_NAME}:</span>';return void 0===e.user?"":(a=a.replace("{USER_COLOR}",e.user.color),a=a.replace("{USER_NAME}",e.user.display_name),a=a.replace("{DATE}",e.time),a=a.replace("{USER_BADGES_ICONS}",e.user.badges),a=a.replace("{SENDER}",e.user.user_name))},Templating.prototype.messageTemplating=function(e){var a='<div class="chat-line">'+this.userTemplating(e)+'<span class="message" style="color: {MESSAGE_COLOR}">{MESSAGE}</span></div>';return a=a.replace("{MESSAGE}",e.processed_message),a=a.replace("{MESSAGE_COLOR}",e.color)},Templating.prototype.emoticonTemplating=function(e){var a='<span class="emoticon" style="background-image: url(//static-cdn.jtvnw.net/emoticons/v1/{ID}/1.0); height: 24px; width: 24px; margin: -5px 0px;"></span>';return a.replace("{ID}",e)},Templating.prototype.subscriberTemplating=function(e){var a='<span class="badge" style="background-image: url({BACKGROUND_IMAGE});"></span>';return a=a.replace("{BACKGROUND_IMAGE}",e)},Templating.prototype.badgeTemplating=function(e){var a='<span class="badge {BADGE}"></span>';return a=a.replace("{BADGE}",e)};
var ChatHandler=function(t,e){this.messageCount=1,this.chatBox=t,this.chatInput=e,this.maxChatMessages=150};ChatHandler.prototype.isScrolledToBottom=function(){return this.chatBox[0].scrollHeight-this.chatBox.scrollTop()-15<=this.chatBox.outerHeight()},ChatHandler.prototype.scrollDown=function(){this.chatBox.scrollTop(this.chatBox[0].scrollHeight)},ChatHandler.prototype.deleteFirstMessages=function(){for(;this.messageCount>this.maxChatMessages;)--this.messageCount,this.chatBox.find(".chat-line").first().remove()},ChatHandler.prototype.addChatLine=function(t){var e=this.isScrolledToBottom();++this.messageCount,this.chatBox.append(t),e&&(this.deleteFirstMessages(),this.scrollDown())},ChatHandler.prototype.removeAllChatLines=function(){this.chatBox.find("div").remove()},ChatHandler.prototype.removeChatLinesFrom=function(t){var e=this.chatBox.find('span[data-sender="'+t+'"]');e.each(function(){$(this).parent().removeClass().addClass("chat-line").addClass("grey"),$(this).parent().find("span.message").text("<message deleted>")})},ChatHandler.prototype.clearChatInput=function(){this.chatInput.val("")},ChatHandler.prototype.trackEvent=function(t,e,a){"undefined"!=typeof ga&&ga("send","event",t,e,a)};
var EmoticonHandler=function(){this.subscriberBadge=null,this.templating=new Templating};EmoticonHandler.prototype.prepareReplaces=function(e,t){for(var r=e.split(":"),n=parseInt(r[0]),s=r[1].split(","),a=0;a<s.length;a++){var i=s[a].split("-"),o=parseInt(i[0]),p=parseInt(i[1]);t.push([o,p,n])}return t},EmoticonHandler.prototype.replaceEmoticons=function(e){if(!e.emotes)return e.message;for(var t=e.emotes.split("/"),r=e.message,n=[],s=0;s<t.length;s++)n=this.prepareReplaces(t[s],n);n.sort(function(e,t){return t[0]-e[0]});for(var s=0;s<n.length;s++){var a=n[s],i=this.templating.emoticonTemplating(a[2]);r=r.replaceBetween(a[0],a[1],i)}return r},EmoticonHandler.prototype.getUserBadges=function(e){for(var t="",r=0;r<e.modes.length;r++){var n=e.modes[r];t+="subscriber"===n?this.templating.badgeSubscriber(this.subscriberBadge):this.templating.badgeTemplating(n)}return t},EmoticonHandler.prototype.setSubscriberBadge=function(e){var t=this;$.ajax({url:"https://api.twitch.tv/kraken/chat/"+e.substring(1)+"/badges",dataType:"jsonp"}).done(function(e){null!==e.subscriber&&(t.subscriberBadge=e.subscriber.image)})};
var TwitchChat=function(){this.socket=io.connect(location.href),this.templating=new Templating,this.chatHandler=new ChatHandler($(".chat-lines"),$(".chat-input")),this.emoticonHandler=new EmoticonHandler,this.userName=""};TwitchChat.prototype.getChatLine=function(t){return t.processed_message=this.emoticonHandler.replaceEmoticons(t).linkify(),t.time=moment(t.time).format("HH:mm"),t.user&&(t.user.badges=this.emoticonHandler.getUserBadges(t.user)),this.templating.messageTemplating(t)},TwitchChat.prototype.addMessage=function(t){var e=this.getChatLine(t);this.chatHandler.addChatLine(e)},TwitchChat.prototype.deleteAllMessages=function(){this.chatHandler.removeAllChatLines()},TwitchChat.prototype.deleteMessages=function(t){this.chatHandler.removeChatLinesFrom(t)},TwitchChat.prototype.sendMessage=function(t,e){""!=t&&(this.socket.emit("message_to_send",t),this.chatHandler.clearChatInput(),this.chatHandler.trackEvent("Sending Messages",e,this.userName))},TwitchChat.prototype.sendCredentials=function(t,e){this.userName=t,this.chatHandler.trackEvent("Twitch Login","Succesful Login",this.userName),this.socket.json.emit("login",{username:t,oauth:"oauth:"+e})};
function initializeTwitch(t){Twitch.init({clientId:t},function(t,e){if(t&&console.log(t),e.authenticated){var c=Twitch.getToken();Twitch.api({method:"user"},function(t,e){t&&console.log(t),twitchChat.sendCredentials(e.name,c)}),$(".chat-input").attr("placeholder","Chat about this Channel")}else $(".chat-input").attr("placeholder","Sign up or log in to chat"),$(".chat-input").attr("disabled","disabled"),$(".twitch-connect").show(),$(".twitch-connect").click(function(){twitchChat.chatHandler.trackEvent("Twitch Login","Button"),Twitch.login({scope:["user_read","chat_login"]})})})}var twitchChat=new TwitchChat;$(document).ready(function(){$(".chat-input").keypress(function(t){13==t.which&&(twitchChat.sendMessage($(".chat-input").val(),"Keyboard"),t.preventDefault())}),$(".send-chat-message").click(function(){twitchChat.sendMessage($(".chat-input").val(),"Button")}),twitchChat.socket.on("init",function(t){initializeTwitch(t.clientId),twitchChat.emoticonHandler.setSubscriberBadge(t.channelName)}),twitchChat.socket.on("message",function(t){twitchChat.addMessage(t)}),twitchChat.socket.on("clear_chat",function(t){twitchChat.deleteMessages(t)}),twitchChat.socket.on("clear_all_chat",function(){twitchChat.deleteAllMessages()})});